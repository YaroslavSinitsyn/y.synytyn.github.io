<!DOCTYPE html>
<meta charset="utf-8">
<style>
    .node circle {
        fill: #288a35;
        stroke: #288a35;
        stroke-width: 1.5px;
    }

    .node {
        font: 10px sans-serif;
    }

    .link {
        fill: none;
        stroke: #808080;
        stroke-width: 1.5px;
    }
    
</style>
<body>
    <div>

    </div>
    <script src="https://d3js.org/d3.v3.min.js"></script>
    <script>


d3.json("tree.json", function (error, root) {

    var flag = false;
    var width = 800, height = 550;
    var tree = d3.layout.tree()
            .size([height-40, width - 160]);

    var svg = d3.select("div").append("svg")
        .attr("width", width)
        .attr("height", height)
        .append("g")
        .attr("transform", "translate(40,40)")

    svg.append("line")
        .style("stroke", "black")
        .attr("x1", 0)
        .attr("y1", 0)
        .attr("x2", 720)
        .attr("y2", 0);

    var rect = svg.append("rect")
        .attr("x", -5)
        .attr("y", -10)
        .attr("width", 10)
        .attr("height", 20)
        .attr("class", 'slider');

    var svgDiv = d3.select("div");

    rect.on("mousedown", function () {
        flag = true;
    });

    svgDiv.on("mousemove", function () {
        if (flag) {
            var x = d3.mouse(this)[0];
            if (x > 40 && x < 765) {
                d3.select(".slider").attr("transform", function () {
                    return "translate(" + (x - 40) + ",0)"
                });
                var a = line.attr("transform", function () {
                    return "translate(" + (x - 40) + ",0)"
                });

                Line.xS = (x - 40);
                Line.yS = 0;
                Line.xE = (x - 40);
                Line.yE = height;
            }
        }

    });

    var Line = {
        xS: 0,
        yS: 0,
        xE: 0,
        yE: height,
        name: ''
    };

    svgDiv.on("mouseup", function () {
        if(flag)
            showPoint();

        flag = false;
    })
    
    function showPoint() {
        var cout = 0;
        arr.forEach(function (b) {
            var name = b.name + "a";
            d3.select('.' + name).remove();
            svg.select('.' + name + 1).remove();

            node.select('.' + b.name)
                        .style("visibility", "hidden");
        });

        arr.forEach(function (a) {
            var result = lineIntersect(Math.round(Line.xS), Math.round(Line.yS), Math.round(Line.xE), Math.round(Line.yE), Math.round(a.xS), Math.round(a.yS), Math.round(a.xE), Math.round(a.yE));

            var name = a.name + "a";

            if (result === true) {
                node.select('.' + a.name)
                        .style("visibility", "visible");

                var t = d3.select('.' + name)[0];

                
                if (t[0] == null && a.rect.y - 2 > 0) {
                    if (cout % 2) {
                        var rect = d3.select("svg")
                            .append("rect")
                            .attr("x", 0)
                            .attr("y", a.rect.y + 38)
                            .attr("width", a.rect.width)
                            .attr("height", a.rect.height + 2)
                            .attr("fill", '#9ed3f8')
                            .attr("fill-opacity", 0.4)
                            .attr("class", name);
                    }
                    else {
                        var rect = d3.select("svg")
                            .append("rect")
                            .attr("x", 0)
                            .attr("y", a.rect.y + 38)
                            .attr("width", a.rect.width)
                            .attr("height", a.rect.height + 2)
                            .attr("fill", '#ffffff')
                            .attr("fill-opacity", 0.4)
                            .attr("class", name);
                    }

                    //if (cout !== 0)
                        d3.select('.'+name).moveToBack();
                }

                if (t[0] == null) {
                    svg.append("text")
                        .attr("x", function (d) { return 0 })
                        .attr("y", function (d) { return a.yS })
                        .attr("class", name + '1')
                        .text(function (d) { return arrayLeters[cout]; });

                    cout += 1;
                }
                
            }
            else {
                node.select('.' + a.name)
                        .style("visibility", "hidden");

                d3.select('.' + name).remove();
                svg.select('.' + name + 1).remove();
            }
        })

    }

    d3.selection.prototype.moveToFront = function () {
        return this.each(function () {
            this.parentNode.appendChild(this);
        });
    };

    d3.selection.prototype.moveToBack = function () {
        return this.each(function () {
            var firstChild = this.parentNode.firstChild;
            if (firstChild) {
                this.parentNode.insertBefore(this, firstChild);
            }
        });
    };

    function elbow(d, i) {
        return "M" + d.source.y + "," + d.source.x
             + "V" + (d.target.x) + "H" + d.target.y;
    }

    var nodes = tree.nodes(root);

    var n = offset(nodes);

    function offset(nodeArray) {
        nodeArray.forEach(function (node) {
            if (node.offset !== undefined) {
                node.y += node.offset;
            }
        });
    }

    var links = tree.links(nodes);

    var tempArray = [];

    console.log(tempArray);
    function findNodeChild(obj)
    {
        console.log(obj);
        for(var i = 0; i < obj.length; i++)
        {
            if (Array.isArray(obj))
            {
                if (Array.isArray(obj[i].children))
                    findNodeChild(obj[i].children);
                else
                {
                    var point = {
                        x: 0,
                        y: 0,
                        name :''
                    }

                    point.x = obj[i].x;
                    point.y = obj[i].y;
                    point.name = obj[i].name;

                    tempArray.push(point);
                }
            }
            
        }
    }

    function rectObj(tempArray) {
        var xMin = 0;
        var xMax = 0;

        tempArray.forEach(function (a) {
            if (xMin === 0 && xMax === 0) {
                xMin = a.x;
                xMax = a.x;
            }

            if (xMin > a.x) {
                xMin = a.x;
            }

            if (xMax < a.x) {
                xMax = a.x;
            }
        });

        return {
            x: 0,
            y: xMin,
            width: 800,
            height: (xMax - xMin)
        }
    }
    
    var arr = [];

    links.forEach(function (l) {
        var coordinatLine = {
            xS: 0,
            yS: 0,
            xE: 0,
            yE: 0,
            name: '',
            rect: {
                x: 0,
                y: 0,
                width: 0,
                height:0
            }
        };

        tempArray = [];

        if (Array.isArray(l.target.children))
            findNodeChild(l.target.children);

        coordinatLine.xS = l.source.y;
        coordinatLine.yS = l.target.x;
        coordinatLine.xE = l.target.y;
        coordinatLine.yE = l.target.x;
        coordinatLine.name = l.target.name;
        coordinatLine.rect = rectObj(tempArray);

        arr.push(coordinatLine);
    });
   
    var link = svg.selectAll(".link")
      .data(links)
      .enter().append("path")
      .attr("class", "link")
      .attr("d", elbow);

   var node = svg.selectAll(".node")
      .data(nodes)
      .enter().append("g")
      .attr("class", "node")
      .attr("transform", function (d) { return "translate(" + d.y + "," + d.x + ")"; });

    var t = node.append("circle")
      .attr("r", 5)
      .style("visibility", "hidden")
      .attr("class", function (d) { return d.name });

    t.on("mousedown", function () {
        console.log('click');
    })

    var arrayLeters = ['A', 'B', 'C', 'D', 'E', 'F', 'G', 'H', 'I', 'J', 'K', 'L', 'M', 'N', 'O','P','Q','R','S','T','U','V','W', 'X', 'Y', 'Z'];
    showPoint();

    function lineIntersect(x1, y1, x2, y2, x3, y3, x4, y4) {
        var x = ((x1 * y2 - y1 * x2) * (x3 - x4) - (x1 - x2) * (x3 * y4 - y3 * x4)) / ((x1 - x2) * (y3 - y4) - (y1 - y2) * (x3 - x4));
        var y = ((x1 * y2 - y1 * x2) * (y3 - y4) - (y1 - y2) * (x3 * y4 - y3 * x4)) / ((x1 - x2) * (y3 - y4) - (y1 - y2) * (x3 - x4));
        if (isNaN(x) || isNaN(y)) {
            return false;
        } else {
            if (x1 >= x2) {
                if (!(x2 <= x && x <= x1)) { return false; }
            } else {
                if (!(x1 <= x && x <= x2)) { return false; }
            }
            if (y1 >= y2) {
                if (!(y2 <= y && y <= y1)) { return false; }
            } else {
                if (!(y1 <= y && y <= y2)) { return false; }
            }
            if (x3 >= x4) {
                if (!(x4 <= x && x <= x3)) { return false; }
            } else {
                if (!(x3 <= x && x <= x4)) { return false; }
            }
            if (y3 >= y4) {
                if (!(y4 <= y && y <= y3)) { return false; }
            } else {
                if (!(y3 <= y && y <= y4)) { return false; }
            }
        }
        return true;
    }

    var line = svg.append("line")
        .style("stroke", "black")
        .attr("x1", 0)
        .attr("y1", 0)
        .attr("x2", 0)
        .attr("y2", height)
        .attr("id", "lineID");
});
    </script>
    </body>
